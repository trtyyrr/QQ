name: Build OnePlus Pad Pro Optimized Kernel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    # æˆäºˆ Actions è¯»å–å’Œå†™å…¥ä»“åº“çš„æƒé™ï¼Œé˜²æ­¢ Clone å¤±è´¥
    permissions:
      contents: write
      actions: write

    steps:
    - name: ğŸ› ï¸ ç¯å¢ƒå‡†å¤‡
      run: |
        sudo apt update
        sudo apt install -y git curl wget build-essential bc bison flex libssl-dev python3 python3-pip android-sdk-libsparse-utils lz4 zstd
        # æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶ Git ä½¿ç”¨ Token è®¤è¯ï¼Œè§£å†³ 128 é”™è¯¯
        git config --global url."https://${{ github.token }}@github.com/".insteadOf "https://github.com/"

    - name: ğŸ“¥ ä¸‹è½½æºç  (ä¿®å¤ç‰ˆ)
      run: |
        mkdir -p workspace && cd workspace
        echo ">>> æ­£åœ¨å…‹éš† Kernel Platform..."
        # åŠ ä¸Šé‡è¯•æœºåˆ¶ï¼Œé˜²æ­¢ç½‘ç»œæ³¢åŠ¨
        git clone --depth 1 https://github.com/OnePlusOSS/kernel_platform.git || (sleep 5 && git clone --depth 1 https://github.com/OnePlusOSS/kernel_platform.git)
        
        echo ">>> æ­£åœ¨å…‹éš† Kernel Source..."
        git clone --depth 1 https://github.com/OnePlusOSS/android_kernel_oneplus_sm8650.git -b oneplus/sm8650_v_15.0.0_pad_pro msm-kernel
        
        # æ‹¼å›¾ç›®å½•ç»“æ„
        ln -snf ../msm-kernel kernel_platform/msm-kernel

    - name: âš¡ æ³¨å…¥æè‡´ä¼˜åŒ–è¡¥ä¸ (æ€§èƒ½+åŠŸè€—+ç½‘ç»œ)
      run: |
        cd workspace/kernel_platform/msm-kernel
        echo ">>> å¼€å§‹åº”ç”¨ä¼˜åŒ–..."

        # 1. å†…å­˜ç®¡ç†ä¼˜åŒ– (MGLRU) - æå‡åŸç¥/å’Œå¹³ç²¾è‹±åŠ è½½é€Ÿåº¦ï¼Œé˜²æ­¢æŠ–éŸ³æ€åå°
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i '$a CONFIG_LRU_GEN=y\nCONFIG_LRU_GEN_ENABLED=y'
        
        # 2. åŠŸè€—ä¼˜åŒ– (RCU Lazy) - é™ä½å¾…æœºå’Œçœ‹æŠ–éŸ³æ—¶çš„ CPU æ¶ˆè€—
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i '$a CONFIG_RCU_LAZY=y'
        
        # 3. ç½‘ç»œæ‰©å±•åŠŸèƒ½ (BBR + CAKE) - è§£å†³ä¸‰è§’æ´²ç­‰æ¸¸æˆé«˜å»¶è¿Ÿ/è·³Ping
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i '$a CONFIG_TCP_CONG_BBR=y\nCONFIG_DEFAULT_TCP_CONG="bbr"'
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i '$a CONFIG_NET_SCH_CAKE=y\nCONFIG_NET_SCH_FQ_CODEL=y'
        
        # 4. zRAM å‹ç¼©ä¼˜åŒ– (ZSTD) - å¢åŠ æœ‰æ•ˆå†…å­˜å®¹é‡
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_ZRAM_DEF_COMP_LZ4=y/# CONFIG_ZRAM_DEF_COMP_LZ4 is not set/g'
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i '$a CONFIG_ZRAM_DEF_COMP_ZSTD=y'

        # 5. æ€§èƒ½å»è‡ƒè‚¿ (ç¦ç”¨ Debug) - å‡å°‘ç³»ç»Ÿå¾®å¡é¡¿
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_SLUB_DEBUG=y/# CONFIG_SLUB_DEBUG is not set/g'
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_DEBUG_INFO=y/# CONFIG_DEBUG_INFO is not set/g'

        # 6. å¼ºåˆ¶å…³é—­ ABL éªŒè¯è¡¥ä¸
        touch .scmversion && echo "" > .scmversion
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_MODULE_SIG_FORCE=y/# CONFIG_MODULE_SIG_FORCE is not set/g'
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_DM_VERITY=y/# CONFIG_DM_VERITY is not set/g'
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_DM_VERITY_AVB=y/# CONFIG_DM_VERITY_AVB is not set/g'

        echo ">>> æ‰€æœ‰è¡¥ä¸æ³¨å…¥æˆåŠŸï¼"

    - name: ğŸ—ï¸ ç¼–è¯‘å†…æ ¸ (Bazel)
      run: |
        cd workspace/kernel_platform
        # ä½¿ç”¨åŸç”Ÿ Bazel è·¯å¾„ï¼Œè·³è¿‡ä¸ç¨³å®šçš„ Python åŒ…è£…å™¨
        export PATH=$PATH:$(pwd)/prebuilts/bazel/linux-x86_64
        python3 build_with_bazel.py -t sm8650 gki --log info || ./../tools/bazel build //msm-kernel:sm8650_gki --jobs=$(nproc)

    - name: ğŸ“¤ ä¸Šä¼ æˆå“
      uses: actions/upload-artifact@v4
      with:
        name: OnePlus_Pad_Pro_Opt_Kernel
        path: |
          workspace/kernel_platform/out/**/dist/Image
          workspace/kernel_platform/out/**/dist/*.ko
          workspace/kernel_platform/out/**/dist/dtb.img
