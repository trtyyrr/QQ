name: Build OnePlus Pad Pro Final Kernel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
    - name: ğŸ› ï¸ 1. ç¯å¢ƒåˆå§‹åŒ–
      run: |
        sudo apt update
        sudo apt install -y git curl wget build-essential bc bison flex libssl-dev python3 python3-pip android-sdk-libsparse-utils lz4 zstd
        # ç§»é™¤å¯èƒ½å¯¼è‡´å†²çªçš„å…¨å±€é…ç½®
        git config --global --unset-all url."https://github.com/".insteadOf || true

    - name: ğŸ“¥ 2. æ‹‰å–æ„å»ºç¯å¢ƒ (ä½¿ç”¨ç¤¾åŒºé•œåƒ)
      uses: actions/checkout@v4
      with:
        # æ›¿æ¢ä¸ºå…¼å®¹ sm8650 çš„ç¤¾åŒºå¹³å°ï¼Œå› ä¸ºå®˜æ–¹ä¸æä¾›æ­¤ä»“åº“
        repository: Yuki-Kernel/kernel_platform
        path: workspace/kernel_platform
        fetch-depth: 1

    - name: ğŸ“¥ 3. æ‹‰å–å®˜æ–¹å†…æ ¸æºç 
      uses: actions/checkout@v4
      with:
        repository: OnePlusOSS/android_kernel_oneplus_sm8650
        ref: oneplus/sm8650_v_15.0.0_pad_pro
        path: workspace/msm-kernel
        fetch-depth: 1

    - name: ğŸ”— 4. å»ºç«‹ç›®å½•é“¾æ¥ (æ‹¼å›¾)
      run: |
        cd workspace
        echo "æ­£åœ¨é“¾æ¥å†…æ ¸æºç åˆ°æ„å»ºç¯å¢ƒ..."
        # ç¡®ä¿ kernel_platform èƒ½æ‰¾åˆ° msm-kernel
        ln -snf ../msm-kernel kernel_platform/msm-kernel
        
        # ä¿®å¤ Yuki-Kernel é•œåƒä¸­å¯èƒ½å­˜åœ¨çš„ build é“¾æ¥é—®é¢˜
        cd kernel_platform
        # å¦‚æœ build ç›®å½•æ˜¯æ­»é“¾æ¥ï¼Œé‡æ–°é“¾æ¥
        if [ -L "build" ] && [ ! -e "build" ]; then
            ln -snf ../msm-kernel/build build
        fi

    - name: âš¡ 5. æ³¨å…¥æè‡´ä¼˜åŒ–è¡¥ä¸
      run: |
        cd workspace/msm-kernel
        echo ">>> å¼€å§‹æ³¨å…¥è¡¥ä¸..."

        # å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥å®‰å…¨åœ°æ‰“è¡¥ä¸
        apply_patch() {
            find arch/arm64/configs -name "*defconfig*" | xargs sed -i "$1" || echo "Warning: Patch failed for $1"
        }

        # --- A. å†…å­˜ä¸æ€§èƒ½ ---
        # MGLRU (å†…å­˜ç®¡ç†ä¼˜åŒ–)
        apply_patch '$a CONFIG_LRU_GEN=y\nCONFIG_LRU_GEN_ENABLED=y'
        # ZSTD (zRAM å‹ç¼©)
        apply_patch 's/CONFIG_ZRAM_DEF_COMP_LZ4=y/# CONFIG_ZRAM_DEF_COMP_LZ4 is not set/g'
        apply_patch '$a CONFIG_ZRAM_DEF_COMP_ZSTD=y'
        # ç¦ç”¨ Debug (æå‡æµç•…åº¦)
        apply_patch 's/CONFIG_SLUB_DEBUG=y/# CONFIG_SLUB_DEBUG is not set/g'
        apply_patch 's/CONFIG_DEBUG_INFO=y/# CONFIG_DEBUG_INFO is not set/g'

        # --- B. ç½‘ç»œä¸åŠŸè€— ---
        # RCU Lazy (çœç”µ)
        apply_patch '$a CONFIG_RCU_LAZY=y'
        # BBR + CAKE (ç½‘ç»œä¼˜åŒ–)
        apply_patch '$a CONFIG_TCP_CONG_BBR=y\nCONFIG_DEFAULT_TCP_CONG="bbr"'
        apply_patch '$a CONFIG_NET_SCH_CAKE=y\nCONFIG_NET_SCH_FQ_CODEL=y'
        
        # --- C. å¼ºåˆ¶å»éªŒè¯ ---
        touch .scmversion && echo "" > .scmversion
        apply_patch 's/CONFIG_MODULE_SIG_FORCE=y/# CONFIG_MODULE_SIG_FORCE is not set/g'
        apply_patch 's/CONFIG_DM_VERITY=y/# CONFIG_DM_VERITY is not set/g'
        apply_patch 's/CONFIG_DM_VERITY_AVB=y/# CONFIG_DM_VERITY_AVB is not set/g'
        
        echo ">>> è¡¥ä¸æ³¨å…¥å®Œæˆï¼"

    - name: ğŸ—ï¸ 6. ç¼–è¯‘å†…æ ¸
      run: |
        cd workspace/kernel_platform
        
        # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
        chmod +x build_with_bazel.py
        
        echo ">>> å¯åŠ¨ç¼–è¯‘..."
        # ä¼˜å…ˆå°è¯• Python è„šæœ¬ï¼Œå¦‚æœå…¼å®¹æ€§æœ‰é—®é¢˜ï¼Œå›é€€åˆ° Bazel ç›´æ¥ç¼–è¯‘
        # æ³¨æ„ï¼šè¿™é‡ŒæŒ‡å®š -t sm8650 æ˜¯åŸºäº Yuki-Kernel å¹³å°çš„é€šç”¨ç›®æ ‡
        python3 build_with_bazel.py -t sm8650 gki --log info || \
        ./tools/bazel build //msm-kernel:sm8650_gki --jobs=$(nproc)

    - name: ğŸ“¤ 7. ä¸Šä¼ æˆå“
      uses: actions/upload-artifact@v4
      with:
        name: OnePlus_Pad_Pro_Kernel_Image
        path: |
          workspace/kernel_platform/out/**/dist/Image
          workspace/kernel_platform/out/**/dist/*.ko
          workspace/kernel_platform/out/**/dist/dtb.img
