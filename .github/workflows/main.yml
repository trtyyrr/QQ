name: Build OnePlus Pad Pro (AOSP Method)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
    - name: ğŸ’¾ 1. æœ€å¤§åŒ–ç£ç›˜ç©ºé—´ (å…³é”®)
      # ç¼–è¯‘ GKI å†…æ ¸éå¸¸åƒç©ºé—´ï¼Œå¿…é¡»å…ˆæ¸…ç†åƒåœ¾é‡Šæ”¾ 20GB+ ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 1024
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'

    - name: ğŸ› ï¸ 2. å®‰è£… Repo å·¥å…·ä¸ä¾èµ–
      run: |
        sudo apt update
        sudo apt install -y git curl wget build-essential bc bison flex libssl-dev python3 python3-pip android-sdk-libsparse-utils lz4 zstd rsync
        
        # å®‰è£… Google çš„ repo å·¥å…·
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH
        
        # é…ç½® Git èº«ä»½ (Repo å·¥å…·éœ€è¦)
        git config --global user.name "Action Builder"
        git config --global user.email "action@localhost"

    - name: ğŸ“¥ 3. åˆå§‹åŒ–æ„å»ºç¯å¢ƒ (AOSP GKI)
      run: |
        mkdir -p workspace
        cd workspace
        
        echo ">>> åˆå§‹åŒ– Google Android 14 GKI æ„å»ºåº•åº§..."
        # ä½¿ç”¨ Google å®˜æ–¹çš„ GKI Manifest (Android 14-6.1 å†…æ ¸)
        # è¿™æ˜¯å…¬å…±çš„ï¼Œç»å¯¹ä¸ä¼šæŠ¥ 404
        repo init -u https://android.googlesource.com/kernel/manifest -b common-android14-6.1 --depth=1
        
        echo ">>> åŒæ­¥æ„å»ºå·¥å…·é“¾ (è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ)..."
        # æˆ‘ä»¬åªéœ€è¦åŒæ­¥æ„å»ºæ‰€éœ€çš„å·¥å…·ï¼Œä¸éœ€è¦åŒæ­¥æ•´ä¸ªå†å²
        repo sync -c -j$(nproc) --no-tags

    - name: ğŸ“¥ 4. æ¤å…¥ OnePlus å†…æ ¸æºç 
      run: |
        cd workspace
        
        echo ">>> å…‹éš† OnePlus SM8650 æºç ..."
        # è¿™é‡Œæˆ‘ä»¬æ‹‰å–ä¸€åŠ çš„å…¬å¼€ä»£ç 
        git clone --depth 1 https://github.com/OnePlusOSS/android_kernel_oneplus_sm8650.git -b oneplus/sm8650_v_15.0.0_pad_pro msm-kernel
        
        # ã€å…³é”®æ­¥éª¤ã€‘å°†ä¸€åŠ æºç é“¾æ¥åˆ° AOSP ç›®å½•ç»“æ„ä¸­
        # Google çš„æ„å»ºè„šæœ¬é€šå¸¸åœ¨ common ç›®å½•æˆ–æ ¹ç›®å½•
        # æˆ‘ä»¬éœ€è¦æ ¹æ® GKI çš„è§„èŒƒï¼Œå°† vendor æºç  (msm-kernel) æ”¾å…¥æ­£ç¡®ä½ç½®
        sed -i 's/CheckPatch/echo "Skipping CheckPatch"/' common/scripts/checkpatch.pl || true

    - name: âš¡ 5. æ³¨å…¥æè‡´ä¼˜åŒ–è¡¥ä¸
      run: |
        cd workspace/msm-kernel
        echo ">>> å¼€å§‹æ³¨å…¥è¡¥ä¸..."

        # å®šä¹‰è¡¥ä¸å‡½æ•°
        apply_patch() {
            find arch/arm64/configs -name "*defconfig*" | xargs sed -i "$1" || echo "Warning: Patch failed for $1"
        }

        # --- A. å†…å­˜ä¸æ€§èƒ½ ---
        apply_patch '$a CONFIG_LRU_GEN=y\nCONFIG_LRU_GEN_ENABLED=y'  # MGLRU
        apply_patch 's/CONFIG_ZRAM_DEF_COMP_LZ4=y/# CONFIG_ZRAM_DEF_COMP_LZ4 is not set/g'
        apply_patch '$a CONFIG_ZRAM_DEF_COMP_ZSTD=y'                 # ZSTD
        apply_patch 's/CONFIG_SLUB_DEBUG=y/# CONFIG_SLUB_DEBUG is not set/g'
        apply_patch 's/CONFIG_DEBUG_INFO=y/# CONFIG_DEBUG_INFO is not set/g'

        # --- B. ç½‘ç»œä¸åŠŸè€— ---
        apply_patch '$a CONFIG_RCU_LAZY=y'                           # RCU Lazy
        apply_patch '$a CONFIG_TCP_CONG_BBR=y\nCONFIG_DEFAULT_TCP_CONG="bbr"'
        apply_patch '$a CONFIG_NET_SCH_CAKE=y\nCONFIG_NET_SCH_FQ_CODEL=y'
        
        # --- C. å¼ºåˆ¶å»éªŒè¯ ---
        touch .scmversion && echo "" > .scmversion
        apply_patch 's/CONFIG_MODULE_SIG_FORCE=y/# CONFIG_MODULE_SIG_FORCE is not set/g'
        apply_patch 's/CONFIG_DM_VERITY=y/# CONFIG_DM_VERITY is not set/g'
        apply_patch 's/CONFIG_DM_VERITY_AVB=y/# CONFIG_DM_VERITY_AVB is not set/g'
        
        echo ">>> è¡¥ä¸æ³¨å…¥å®Œæˆï¼"

    - name: ğŸ—ï¸ 6. ç¼–è¯‘å†…æ ¸ (ä½¿ç”¨ Google å·¥å…·é“¾)
      run: |
        cd workspace
        
        echo ">>> å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ..."
        # å¾ˆå¤šæ—¶å€™éœ€è¦æ‰‹åŠ¨è®¾ç½® LTO æ¨¡å¼ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
        export LTO=thin
        
        echo ">>> å¯åŠ¨ç¼–è¯‘ (Target: sm8650_gki)..."
        # ä½¿ç”¨ Google æä¾›çš„ build_with_bazel.py
        # æ³¨æ„ï¼šæˆ‘ä»¬éœ€è¦å‘Šè¯‰ Bazel æˆ‘ä»¬çš„ msm-kernel åœ¨å“ªé‡Œ
        # é€šå¸¸é€šè¿‡ --//msm-kernel:target æ–¹å¼ï¼Œæˆ–è€…é€šè¿‡è½¯é“¾æ¥
        
        # å»ºç«‹è½¯é“¾æ¥è®© Bazel æ‰¾åˆ° msm-kernel (å¦‚æœ Google ç»“æ„ä¸åŒ)
        ln -snf msm-kernel common/msm-kernel
        
        # å°è¯•ç›´æ¥ç¼–è¯‘ msm-kernel å®šä¹‰çš„ç›®æ ‡
        # ä½¿ç”¨ Bazel ç›´æ¥ç¼–è¯‘æ˜¯æœ€ç¨³çš„ï¼Œç»•è¿‡ Python è„šæœ¬çš„è·¯å¾„æ£€æŸ¥
        tools/bazel build //msm-kernel:sm8650_gki --jobs=$(nproc)

    - name: ğŸ“¤ 7. ä¸Šä¼ æˆå“
      uses: actions/upload-artifact@v4
      with:
        name: OnePlus_Pad_Pro_AOSP_Kernel
        path: |
          workspace/out/**/dist/Image
          workspace/out/**/dist/*.ko
          workspace/out/**/dist/dtb.img
