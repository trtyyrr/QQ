name: Build OnePlus Pad Pro (Community Manifest)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
    - name: ğŸ’¾ 1. æœ€å¤§åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 8192
        swap-size-mb: 4096
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-codeql: 'true'

    - name: ğŸ› ï¸ 2. å®‰è£…æ„å»ºç¯å¢ƒ
      run: |
        sudo apt update
        sudo apt install -y git curl wget build-essential bc bison flex libssl-dev python3 python3-pip android-sdk-libsparse-utils lz4 zstd rsync
        
        # å®‰è£… Repo
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH
        
        # é…ç½® Git
        git config --global user.name "Builder"
        git config --global user.email "bot@localhost"
        git config --global color.ui false

    - name: ğŸ“¥ 3. åŒæ­¥æºç  (ä½¿ç”¨ç¤¾åŒº Manifest)
      run: |
        mkdir -p workspace
        cd workspace
        
        echo ">>> åˆå§‹åŒ– Repo..."
        # æ ¸å¿ƒä¿®æ”¹ç‚¹ï¼šå¼•ç”¨ Xiaomichael çš„å…¬å¼€æ¸…å•åº“
        # -b refs/heads/oneplus/sm8650: æŒ‡å®šéªé¾™8Gen3åˆ†æ”¯
        # -m oneplus_pad_pro_v.xml: æŒ‡å®šä¸€åŠ å¹³æ¿Proçš„é…ç½®æ¸…å•
        repo init -u https://github.com/Xiaomichael/kernel_manifest.git -b refs/heads/oneplus/sm8650 -m oneplus_pad_pro_v.xml --depth=1
        
        echo ">>> å¼€å§‹åŒæ­¥æºç ..."
        # å¹¶å‘åŒæ­¥ï¼Œå¼ºåˆ¶è¦†ç›–
        repo sync -c -j$(nproc) --force-sync --no-tags --no-clone-bundle

    - name: âš¡ 4. æ³¨å…¥ä½ çš„ä¸“å±ä¼˜åŒ– (ä¿ç•™ä½ çš„éœ€æ±‚)
      run: |
        # è¿›å…¥å†…æ ¸æºç ç›®å½• (Manifest ä¼šæŠŠå®ƒæ”¾åœ¨ kernel_platform/msm-kernel)
        cd workspace/kernel_platform/msm-kernel
        
        echo ">>> å¼€å§‹æ³¨å…¥ä¼˜åŒ–è¡¥ä¸..."
        
        apply_patch() {
            find arch/arm64/configs -name "*defconfig*" | xargs sed -i "$1" || echo "Warn: $1"
        }

        # --- A. å†…å­˜ä¸æ€§èƒ½ (MGLRU + ZSTD) ---
        apply_patch '$a CONFIG_LRU_GEN=y\nCONFIG_LRU_GEN_ENABLED=y'
        apply_patch 's/CONFIG_ZRAM_DEF_COMP_LZ4=y/# CONFIG_ZRAM_DEF_COMP_LZ4 is not set/g'
        apply_patch '$a CONFIG_ZRAM_DEF_COMP_ZSTD=y'
        # ç¦ç”¨ Debug ä»¥æå‡æ€§èƒ½
        apply_patch 's/CONFIG_SLUB_DEBUG=y/# CONFIG_SLUB_DEBUG is not set/g'
        apply_patch 's/CONFIG_DEBUG_INFO=y/# CONFIG_DEBUG_INFO is not set/g'

        # --- B. ç½‘ç»œä¸åŠŸè€— (BBR + RCU Lazy) ---
        apply_patch '$a CONFIG_RCU_LAZY=y'
        apply_patch '$a CONFIG_TCP_CONG_BBR=y\nCONFIG_DEFAULT_TCP_CONG="bbr"'
        apply_patch '$a CONFIG_NET_SCH_CAKE=y\nCONFIG_NET_SCH_FQ_CODEL=y'

        # --- C. ç»•è¿‡éªŒè¯ (å» Dirty + å»ç­¾å) ---
        # ä¿®å¤ç‰ˆæœ¬å· dirty åç¼€
        sed -i 's/ -dirty//g' scripts/setlocalversion
        sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' scripts/setlocalversion
        touch .scmversion && echo "" > .scmversion
        
        # å…³é—­å†…æ ¸éªŒè¯
        apply_patch 's/CONFIG_MODULE_SIG_FORCE=y/# CONFIG_MODULE_SIG_FORCE is not set/g'
        apply_patch 's/CONFIG_DM_VERITY=y/# CONFIG_DM_VERITY is not set/g'
        apply_patch 's/CONFIG_DM_VERITY_AVB=y/# CONFIG_DM_VERITY_AVB is not set/g'
        
        echo ">>> ä¼˜åŒ–æ³¨å…¥å®Œæˆï¼"

    - name: ğŸ”§ 5. ä¼ªé€ ç§æœ‰åº“ (Bazel å®‰å…¨ç½‘)
      run: |
        cd workspace/kernel_platform
        
        echo ">>> Mocking Oplus Private Libraries..."
        # å³ä½¿ä½¿ç”¨äº†ç¤¾åŒº Manifestï¼Œç§æœ‰çš„ oplus åº“ä¾ç„¶å¯èƒ½ç¼ºå¤±
        # æˆ‘ä»¬ç»§ç»­ä½¿ç”¨ä¹‹å‰çš„ Mock æŠ€å·§ï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±
        
        mkdir -p oplus/bazel
        touch oplus/bazel/BUILD
        
        cat <<EOF > oplus/bazel/oplus_modules_define.bzl
        def define_oplus_ddk_module(**kwargs): pass
        def define_oplus_module(**kwargs): pass
        def oplus_module(**kwargs): pass
        def oplus_ddk_module(**kwargs): pass
        EOF

        mkdir -p vendor/oplus
        ln -snf ../../oplus/bazel vendor/oplus/bazel || true

    - name: ğŸ—ï¸ 6. å¯åŠ¨ç¼–è¯‘ (Bazel)
      run: |
        cd workspace/kernel_platform
        
        echo ">>> å‡†å¤‡ç¼–è¯‘..."
        export LTO=thin
        
        # ç¤¾åŒº Manifest æ‹‰å–çš„ä»£ç é€šå¸¸å…¼å®¹å®˜æ–¹ build_with_bazel.py
        # æˆ‘ä»¬ä¼˜å…ˆä½¿ç”¨å®ƒ
        echo ">>> å¯åŠ¨æ„å»º (Target: sm8650 gki)..."
        
        # å°è¯•ç¼–è¯‘ï¼Œå¦‚æœ Python è„šæœ¬å¤±è´¥ï¼Œå›é€€åˆ° Bazel åŸç”Ÿå‘½ä»¤
        python3 build_with_bazel.py -t sm8650 gki --log info || \
        ./tools/bazel build //msm-kernel:sm8650_gki --jobs=$(nproc)

    - name: ğŸ“¤ 7. ä¸Šä¼ æˆå“
      uses: actions/upload-artifact@v4
      with:
        name: OnePlus_Pad_Pro_Optimized_Kernel
        path: |
          workspace/kernel_platform/out/**/dist/Image
          workspace/kernel_platform/out/**/dist/*.ko
          workspace/kernel_platform/out/**/dist/dtb.img