name: Build OnePlus Pad Pro (Pure + Optimizations)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
    - name: 💾 1. 准备磁盘空间
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 8192
        swap-size-mb: 4096
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-codeql: 'true'

    - name: 🛠️ 2. 安装基础工具
      run: |
        sudo apt update
        sudo apt install -y git curl wget build-essential bc bison flex libssl-dev python3 python3-pip android-sdk-libsparse-utils lz4 zstd rsync
        
        # 安装 Repo
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH
        git config --global user.name "Builder"
        git config --global user.email "bot@localhost"

    - name: 📥 3. 拉取源码 (使用社区 Manifest)
      run: |
        mkdir -p workspace
        cd workspace
        
        # 使用社区维护的 Manifest，它指向了一加官方的源码
        repo init -u https://github.com/Xiaomichael/kernel_manifest.git -b refs/heads/oneplus/sm8650 -m oneplus_pad_pro_v.xml --depth=1
        repo sync -c -j$(nproc) --force-sync --no-tags --no-clone-bundle

    - name: ⚡ 4. 应用优化补丁 (只做你要求的)
      run: |
        cd workspace/kernel_platform/msm-kernel
        
        echo ">>> 正在应用性能与网络优化..."
        
        # 定义一个简单的打补丁函数
        add_config() {
            find arch/arm64/configs -name "*defconfig*" | xargs sed -i "$1"
        }

        # 1. 内存优化 (MGLRU + ZSTD)
        add_config '$a CONFIG_LRU_GEN=y\nCONFIG_LRU_GEN_ENABLED=y'
        add_config 's/CONFIG_ZRAM_DEF_COMP_LZ4=y/# CONFIG_ZRAM_DEF_COMP_LZ4 is not set/g'
        add_config '$a CONFIG_ZRAM_DEF_COMP_ZSTD=y'
        
        # 2. 性能优化 (去除 Debug)
        add_config 's/CONFIG_SLUB_DEBUG=y/# CONFIG_SLUB_DEBUG is not set/g'
        add_config 's/CONFIG_DEBUG_INFO=y/# CONFIG_DEBUG_INFO is not set/g'

        # 3. 网络与功耗 (BBR + RCU Lazy)
        add_config '$a CONFIG_RCU_LAZY=y'
        add_config '$a CONFIG_TCP_CONG_BBR=y\nCONFIG_DEFAULT_TCP_CONG="bbr"'
        add_config '$a CONFIG_NET_SCH_CAKE=y\nCONFIG_NET_SCH_FQ_CODEL=y'

        # 4. 去除验证 (保留原始版本号，去掉 dirty，去掉签名强制)
        sed -i 's/ -dirty//g' scripts/setlocalversion
        sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' scripts/setlocalversion
        touch .scmversion && echo "" > .scmversion
        
        add_config 's/CONFIG_MODULE_SIG_FORCE=y/# CONFIG_MODULE_SIG_FORCE is not set/g'
        add_config 's/CONFIG_DM_VERITY=y/# CONFIG_DM_VERITY is not set/g'
        add_config 's/CONFIG_DM_VERITY_AVB=y/# CONFIG_DM_VERITY_AVB is not set/g'

    - name: 🔧 5. 还原缺失的官方接口文件 (不做魔改，只做补全)
      run: |
        cd workspace/kernel_platform
        
        echo ">>> 正在还原官方闭源的 Bazel