name: Build OnePlus Pad Pro (Pure Performance)

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  build-kernel:
    runs-on: ubuntu-22.04
    
    steps:
    - name: ğŸ› ï¸ 1. ç¯å¢ƒåˆå§‹åŒ–
      run: |
        sudo apt update
        sudo apt install -y git curl wget build-essential bc bison flex libssl-dev python3 python3-pip android-sdk-libsparse-utils lz4 zstd
        git config --global user.name "OnePlus Builder"
        git config --global user.email "bot@github.com"

    - name: ğŸ“¥ 2. å…‹éš†æºç 
      run: |
        mkdir -p workspace
        cd workspace
        echo "æ­£åœ¨æ‹‰å–æºç ..."
        git clone --depth 1 https://github.com/OnePlusOSS/kernel_platform.git
        git clone --depth 1 https://github.com/OnePlusOSS/android_kernel_oneplus_sm8650.git -b oneplus/sm8650_v_15.0.0_pad_pro msm-kernel
        ln -snf ../msm-kernel kernel_platform/msm-kernel
        mkdir -p kernel_platform/prebuilts/bazel/linux-x86_64

    - name: âš¡ 3. æ³¨å…¥çº¯å‡€ä¼˜åŒ–è¡¥ä¸
      run: |
        cd workspace/kernel_platform/msm-kernel
        echo ">>> å¼€å§‹åº”ç”¨å…¼å®¹æ€§ä¼˜åŒ–è¡¥ä¸..."

        # ==================== A. å†…å­˜ç®¡ç†é©å‘½ (MGLRU) ====================
        # MGLRU æ˜¯æ¯”ä¼ ç»Ÿ LMK æ›´å…ˆè¿›çš„å†…å­˜å›æ”¶æœºåˆ¶ï¼Œæ˜¾è‘—å‡å°‘æ€åå°å’Œå¡é¡¿
        # å°è¯•åœ¨é…ç½®ä¸­å¯ç”¨å®ƒ (å¦‚æœå†…æ ¸ç‰ˆæœ¬æ”¯æŒ 6.1+)
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i '$a CONFIG_LRU_GEN=y\nCONFIG_LRU_GEN_ENABLED=y'
        
        # zRAM å‹ç¼©ç®—æ³•å‡çº§ä¸º ZSTD (æ¯”é»˜è®¤çš„ lzo/lz4 æ›´å¼º)
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_ZRAM_DEF_COMP_LZ4=y/# CONFIG_ZRAM_DEF_COMP_LZ4 is not set/g'
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i '$a CONFIG_ZRAM_DEF_COMP_ZSTD=y'

        # ==================== B. ç½‘ç»œä½å»¶è¿Ÿå¥—ä»¶ ====================
        # å¼€å¯ TCP BBR (æ‹¥å¡æ§åˆ¶)
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i '$a CONFIG_TCP_CONG_BBR=y\nCONFIG_DEFAULT_TCP_CONG="bbr"'
        # å¼€å¯ CAKE & FQ_CODEL (è§£å†³æ¸¸æˆæ—¶çš„ç½‘ç»œæ’é˜Ÿå»¶è¿Ÿ)
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i '$a CONFIG_NET_SCH_CAKE=y\nCONFIG_NET_SCH_FQ_CODEL=y'
        # å¼€å¯ WireGuard (ä¸ºæ¸¸æˆåŠ é€Ÿå™¨æä¾›åº•å±‚æ”¯æŒ)
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i '$a CONFIG_WIREGUARD=y'

        # ==================== C. åŠŸè€—ä¸æ€§èƒ½å¹³è¡¡ ====================
        # å¼€å¯ RCU Lazy (æ˜¾è‘—é™ä½ç©ºé—²/å¾…æœºæ—¶çš„ CPU å”¤é†’é¢‘ç‡ï¼Œçœç”µ)
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i '$a CONFIG_RCU_LAZY=y'
        
        # ç§»é™¤ SLUB Debug (å‡å°‘å†…å­˜åˆ†é…çš„é¢å¤–æ£€æŸ¥ï¼Œæå‡åŸç¥/å’Œå¹³ç²¾è‹±çš„æµç•…åº¦)
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_SLUB_DEBUG=y/# CONFIG_SLUB_DEBUG is not set/g'
        
        # ç§»é™¤å†…æ ¸è°ƒè¯•ä¿¡æ¯ (å‡å°å†…æ ¸ä½“ç§¯ï¼ŒåŠ å¿«å¯åŠ¨é€Ÿåº¦)
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_DEBUG_INFO=y/# CONFIG_DEBUG_INFO is not set/g'

        # ==================== D. å¼ºåˆ¶å…³é—­å†…æ ¸çº§éªŒè¯ ====================
        # 1. ç§»é™¤ dirty ç‰ˆæœ¬å·åç¼€ (é˜²æ­¢ä¸å…¼å®¹)
        touch .scmversion && echo "" > .scmversion
        
        # 2. å…³é—­æ¨¡å—å¼ºåˆ¶ç­¾å (å…è®¸ä½ ä»¥ååŠ è½½ä»»ä½•ç¬¬ä¸‰æ–¹ ko æ¨¡å—)
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_MODULE_SIG_FORCE=y/# CONFIG_MODULE_SIG_FORCE is not set/g'
        
        # 3. å°è¯•å…³é—­å†…æ ¸ä¾§çš„ AVB æ ‡å¿— (é…åˆ fastboot å‘½ä»¤ä½¿ç”¨æ•ˆæœæ›´ä½³)
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_DM_VERITY=y/# CONFIG_DM_VERITY is not set/g'
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_DM_VERITY_AVB=y/# CONFIG_DM_VERITY_AVB is not set/g'
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_ANDROID_VERITY=y/# CONFIG_ANDROID_VERITY is not set/g'

        echo ">>> ä¼˜åŒ–å®Œæˆï¼Œå·²ç§»é™¤æ‰€æœ‰ Root/éšè—ç±»è¡¥ä¸ï¼"

    - name: ğŸ—ï¸ 4. å¼€å§‹ç¼–è¯‘
      run: |
        cd workspace/kernel_platform
        # ä¼˜å…ˆä½¿ç”¨ Python è„šæœ¬ï¼Œå¤±è´¥åˆ™å›é€€åˆ° Bazel åŸç”ŸæŒ‡ä»¤
        python3 build_with_bazel.py -t sm8650 gki --log info || \
        ../tools/bazel build //msm-kernel:sm8650_gki --jobs=$(nproc)

    - name: ğŸ“¤ 5. ä¸Šä¼ æˆå“
      uses: actions/upload-artifact@v4
      with:
        name: OnePlus_Pad_Pro_Pure_Kernel
        path: |
          workspace/kernel_platform/out/**/dist/Image
          workspace/kernel_platform/out/**/dist/*.ko
          workspace/kernel_platform/out/**/dist/dtb.img

