name: Build OnePlus Pad Pro Optimized Kernel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
    - name: ğŸ› ï¸ 1. ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–
      run: |
        sudo apt update
        sudo apt install -y git curl wget build-essential bc bison flex libssl-dev python3 python3-pip android-sdk-libsparse-utils lz4 zstd

    - name: ğŸ“¥ 2. æ‹‰å– Kernel Platform (å®˜æ–¹æ’ä»¶ç‰ˆ)
      uses: actions/checkout@v4
      with:
        repository: OnePlusOSS/kernel_platform
        path: workspace/kernel_platform
        fetch-depth: 1

    - name: ğŸ“¥ 3. æ‹‰å– msm-kernel (å®˜æ–¹æ’ä»¶ç‰ˆ)
      uses: actions/checkout@v4
      with:
        repository: OnePlusOSS/android_kernel_oneplus_sm8650
        ref: oneplus/sm8650_v_15.0.0_pad_pro
        path: workspace/msm-kernel
        fetch-depth: 1

    - name: ğŸ”— 4. å»ºç«‹ç›®å½•é“¾æ¥
      run: |
        cd workspace
        # å»ºç«‹æ‹¼å›¾ç»“æ„ï¼Œç¡®ä¿ kernel_platform èƒ½æ‰¾åˆ° msm-kernel
        ln -snf ../msm-kernel kernel_platform/msm-kernel

    - name: âš¡ 5. æ³¨å…¥æè‡´ä¼˜åŒ–è¡¥ä¸ (æ€§èƒ½/åŠŸè€—/ç½‘ç»œ)
      run: |
        cd workspace/msm-kernel
        echo ">>> å¼€å§‹æ³¨å…¥è¡¥ä¸..."

        # å†…å­˜ç®¡ç†ä¼˜åŒ–: MGLRU (é˜²æ­¢æ€åå°/å‡å°‘ç¬é—´å¡é¡¿)
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i '$a CONFIG_LRU_GEN=y\nCONFIG_LRU_GEN_ENABLED=y'
        
        # åŠŸè€—ä¼˜åŒ–: RCU Lazy (æå‡å¾…æœºç»­èˆª)
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i '$a CONFIG_RCU_LAZY=y'
        
        # ç½‘ç»œåŠ é€Ÿ: BBR + CAKE (é™ä½æ¸¸æˆå»¶è¿Ÿ)
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i '$a CONFIG_TCP_CONG_BBR=y\nCONFIG_DEFAULT_TCP_CONG="bbr"'
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i '$a CONFIG_NET_SCH_CAKE=y\nCONFIG_NET_SCH_FQ_CODEL=y'
        
        # å‹ç¼©ç®—æ³•: ZSTD (æå‡å†…å­˜å¯ç”¨ç‡)
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_ZRAM_DEF_COMP_LZ4=y/# CONFIG_ZRAM_DEF_COMP_LZ4 is not set/g'
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i '$a CONFIG_ZRAM_DEF_COMP_ZSTD=y'

        # æ€§èƒ½å»è‡ƒè‚¿: ç¦ç”¨ Debug
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_SLUB_DEBUG=y/# CONFIG_SLUB_DEBUG is not set/g'
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_DEBUG_INFO=y/# CONFIG_DEBUG_INFO is not set/g'

        # å¼ºåˆ¶å…³é—­ ABL éªŒè¯è¡¥ä¸ (å†…æ ¸ä¾§)
        touch .scmversion && echo "" > .scmversion
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_MODULE_SIG_FORCE=y/# CONFIG_MODULE_SIG_FORCE is not set/g'
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_DM_VERITY=y/# CONFIG_DM_VERITY is not set/g'
        find arch/arm64/configs -name "*defconfig*" | xargs sed -i 's/CONFIG_DM_VERITY_AVB=y/# CONFIG_DM_VERITY_AVB is not set/g'
        
        echo ">>> è¡¥ä¸æ³¨å…¥æˆåŠŸï¼"

    - name: ğŸ—ï¸ 6. ç¼–è¯‘å†…æ ¸ (Bazel)
      run: |
        cd workspace/kernel_platform
        # ç¡®ä¿æƒé™
        chmod +x build/bazel/bin/bazel || true
        # å¯åŠ¨ç¼–è¯‘
        python3 build_with_bazel.py -t sm8650 gki --log info || ./../tools/bazel build //msm-kernel:sm8650_gki --jobs=$(nproc)

    - name: ğŸ“¤ 7. ä¸Šä¼ æˆå“
      uses: actions/upload-artifact@v4
      with:
        name: OnePlus_Pad_Pro_Pure_Kernel
        path: |
          workspace/kernel_platform/out/**/dist/Image
          workspace/kernel_platform/out/**/dist/*.ko
          workspace/kernel_platform/out/**/dist/dtb.img
