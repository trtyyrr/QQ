name: Build OnePlus Pad Pro (Manifest Mode)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
    - name: ğŸ’¾ 1. æœ€å¤§åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 4096
        swap-size-mb: 1024
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'

    - name: ğŸ› ï¸ 2. å®‰è£… Repo å’ŒåŸºç¡€å·¥å…·
      run: |
        sudo apt update
        sudo apt install -y git curl wget build-essential bc bison flex libssl-dev python3 python3-pip android-sdk-libsparse-utils lz4 zstd rsync
        
        # å®‰è£… Repo
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH
        
        # é…ç½® Git
        git config --global user.name "Manifest Builder"
        git config --global user.email "builder@localhost"
        git config --global color.ui false

    - name: ğŸ“ 3. ç”Ÿæˆ Manifest æ¸…å•æ–‡ä»¶
      run: |
        mkdir -p workspace
        cd workspace
        
        # åˆ›å»ºæ¸…å•æ–‡ä»¶ (æ³¨æ„ï¼šè¿™é‡Œå·²ä¿®å¤ç¼©è¿›é—®é¢˜)
        # ä½¿ç”¨ echo é€è¡Œå†™å…¥å¤´éƒ¨ï¼Œé¿å… EOF ç¼©è¿›é”™è¯¯
        echo '<?xml version="10" encoding="UTF-8"?>' > default.xml
        echo '<manifest>' >> default.xml
        echo '  <remote fetch="https://git.codelinaro.org/clo/la" name="clo-la"/>' >> default.xml
        echo '  <default remote="clo-la" revision="dummy_revision" sync-c="true" sync-tags="false"/>' >> default.xml
        echo '  <remote fetch="https://github.com/OnePlusOSS" name="origin"/>' >> default.xml
        
        # å†™å…¥é¡¹ç›®å®šä¹‰ (OnePlus Projects)
        echo '  <project remote="origin" name="android_kernel_common_oneplus_sm8650" path="kernel_platform/common" revision="oneplus/sm8650_v_15.0.0_pad_pro">' >> default.xml
        echo '    <linkfile dest="kernel_platform/.source_date_epoch_dir" src="."/>' >> default.xml
        echo '  </project>' >> default.xml
        echo '  <project remote="origin" name="android_kernel_oneplus_sm8650" path="kernel_platform/msm-kernel" revision="oneplus/sm8650_v_15.0.0_pad_pro">' >> default.xml
        echo '    <linkfile dest="kernel_platform/WORKSPACE" src="bazel.WORKSPACE"/>' >> default.xml
        echo '    <linkfile dest="kernel_platform/build_with_bazel.py" src="build_with_bazel.py"/>' >> default.xml
        echo '  </project>' >> default.xml
        echo '  <project remote="origin" name="android_kernel_modules_and_devicetree_oneplus_sm8650" path="./" revision="oneplus/sm8650_v_15.0.0_pad_pro"/>' >> default.xml
        
        # å†™å…¥ä¾èµ–åº“ (CodeLinaro Projects)
        echo '  <project remote="clo-la" name="kernel/prebuilts/build-tools" path="kernel_platform/prebuilts/kernel-build-tools" revision="d153b7ab4a4956198957e258d4f370e875c53059" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel" clone-depth="1">' >> default.xml
        echo '    <linkfile dest="kernel_platform/build/prebuilts/kernel-build-tools" src="."/>' >> default.xml
        echo '  </project>' >> default.xml
        echo '  <project remote="clo-la" name="kernel_platform/build/bazel_common_rules" path="kernel_platform/build/bazel_common_rules" revision="415b543d5e1d270a22f8c6ae9d848b3560472062" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel" clone-depth="1"/>' >> default.xml
        echo '  <project remote="clo-la" name="kernel_platform/external/bazel-skylib" path="kernel_platform/external/bazel-skylib" revision="7fdbc462f5001b7e82f026aa90bd43c494e2a8d8" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel" clone-depth="1"/>' >> default.xml
        echo '  <project remote="clo-la" name="kernel_platform/external/dtc" path="kernel_platform/external/dtc" revision="3a8c1bbce993f9143835c7f40eeefcdf948cfaf5" upstream="refs/heads/kernel.build.lnx.1.0.r15-rel" clone-depth="1"/>' >> default.xml
        echo '  <project remote="clo-la" name="kernel_platform/external/python/absl-py" path="kernel_platform/external/python/absl-py" revision="e46584edbb247bf79c74c4f105b6fff18234cee8" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel" clone-depth="1"/>' >> default.xml
        echo '  <project remote="clo-la" name="kernel_platform/external/stardoc" path="kernel_platform/external/stardoc" revision="0d74fed6f8d0844f696771e71bc0b071cae99021" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel" clone-depth="1"/>' >> default.xml
        echo '  <project remote="clo-la" name="kernel_platform/prebuilts/bazel/linux-x86_64" path="kernel_platform/prebuilts/bazel/linux-x86_64" revision="eee09422f02e60f28192bcb5a8ce8660baba6706" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel" clone-depth="1"/>' >> default.xml
        echo '  <project remote="clo-la" name="kernel_platform/prebuilts/build-tools" path="kernel_platform/prebuilts/build-tools" revision="cad7e11de82b3307000e09c9d539b2700bd17aea" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel" clone-depth="1">' >> default.xml
        echo '    <linkfile dest="kernel_platform/build/prebuilts/build-tools" src="."/>' >> default.xml
        echo '  </project>' >> default.xml
        echo '  <project remote="clo-la" name="kernel_platform/prebuilts/clang-tools" path="kernel_platform/prebuilts/clang-tools" revision="0613fc5443d035335a9541994607bacae03750f2" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel" clone-depth="1">' >> default.xml
        echo '    <linkfile dest="kernel_platform/build/prebuilts/clang-tools" src="."/>' >> default.xml
        echo '  </project>' >> default.xml
        echo '  <project remote="clo-la" name="kernel_platform/prebuilts/jdk/jdk11" path="kernel_platform/prebuilts/jdk/jdk11" revision="ced68c9308cbc1b6ec3e602dba8d0d56df8b6d73" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel" clone-depth="1"/>' >> default.xml
        echo '  <project remote="clo-la" name="kernel_platform/system/tools/mkbootimg" path="kernel_platform/tools/mkbootimg" revision="b17f184a20744a7e0a421f901bdf20a23be22b07" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel" clone-depth="1"/>' >> default.xml
        echo '  <project remote="clo-la" name="kernel_platform/toolchain/prebuilts/ndk/r23" path="kernel_platform/prebuilts/ndk-r23" revision="269a5dc9e862f78dc2030d9262f73cb2642b8127" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel" clone-depth="1"/>' >> default.xml
        echo '  <project remote="clo-la" name="kernelplatform/prebuilts-master/clang/host/linux-x86" path="kernel_platform/prebuilts/clang/host/linux-x86" revision="28b975ada54f8610ed531a6b57253aed10e7c87d" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel" clone-depth="1"/>' >> default.xml
        echo '  <project remote="clo-la" name="kernelplatform/prebuilts/gcc/linux-x86/host/x86_64-linux-glibc2.17-4.8" path="kernel_platform/prebuilts/gcc/linux-x86/host/x86_64-linux-glibc2.17-4.8" revision="dd099b5d68822602228e2af66693e61e7b54e0a9" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel" clone-depth="1">' >> default.xml
        echo '    <linkfile dest="kernel_platform/build/build-tools/sysroot" src="sysroot"/>' >> default.xml
        echo '  </project>' >> default.xml
        echo '</manifest>' >> default.xml

    - name: ğŸ“¥ 4. é€šè¿‡ Manifest è¿˜åŸæºç 
      run: |
        cd workspace
        
        echo ">>> åˆå§‹åŒ–ä»“åº“..."
        # å…ˆåˆå§‹åŒ–ä¸€ä¸ªç©ºçš„ä¸€åŠ ä»“åº“ä½œä¸ºå ä½
        repo init -u https://github.com/OnePlusOSS/kernel_platform -b oneplus/sm8650_v_15.0.0_pad_pro || true
        
        echo ">>> æ›¿æ¢ä¸ºè‡ªå®šä¹‰ Manifest..."
        mkdir -p .repo/manifests
        mv default.xml .repo/manifests/default.xml
        
        echo ">>> å¼€å§‹åŒæ­¥ (å¯èƒ½éœ€è¦ 10-15 åˆ†é’Ÿ)..."
        # å¼ºåˆ¶å¹¶å‘åŒæ­¥
        repo sync -c -j$(nproc) --force-sync --no-tags --no-clone-bundle

    - name: âš¡ 5. æ³¨å…¥ä¼˜åŒ–è¡¥ä¸
      run: |
        cd workspace/kernel_platform/msm-kernel
        echo ">>> æ­£åœ¨æ³¨å…¥ä¼˜åŒ–è¡¥ä¸..."
        
        apply_patch() {
            find arch/arm64/configs -name "*defconfig*" | xargs sed -i "$1" || echo "Warn: $1"
        }

        # å†…å­˜ä¸æ€§èƒ½
        apply_patch '$a CONFIG_LRU_GEN=y\nCONFIG_LRU_GEN_ENABLED=y'
        apply_patch 's/CONFIG_ZRAM_DEF_COMP_LZ4=y/# CONFIG_ZRAM_DEF_COMP_LZ4 is not set/g'
        apply_patch '$a CONFIG_ZRAM_DEF_COMP_ZSTD=y'
        apply_patch 's/CONFIG_SLUB_DEBUG=y/# CONFIG_SLUB_DEBUG is not set/g'
        apply_patch 's/CONFIG_DEBUG_INFO=y/# CONFIG_DEBUG_INFO is not set/g'

        # ç½‘ç»œä¸åŠŸè€—
        apply_patch '$a CONFIG_RCU_LAZY=y'
        apply_patch '$a CONFIG_TCP_CONG_BBR=y\nCONFIG_DEFAULT_TCP_CONG="bbr"'
        apply_patch '$a CONFIG_NET_SCH_CAKE=y\nCONFIG_NET_SCH_FQ_CODEL=y'
        
        # å»éªŒè¯
        touch .scmversion && echo "" > .scmversion
        apply_patch 's/CONFIG_MODULE_SIG_FORCE=y/# CONFIG_MODULE_SIG_FORCE is not set/g'
        apply_patch 's/CONFIG_DM_VERITY=y/# CONFIG_DM_VERITY is not set/g'
        apply_patch 's/CONFIG_DM_VERITY_AVB=y/# CONFIG_DM_VERITY_AVB is not set/g'

    - name: ğŸ”§ 6. ä¼ªé€ ç§æœ‰åº“
      run: |
        cd workspace/kernel_platform
        
        echo ">>> Mocking Oplus Private Modules..."
        mkdir -p oplus/bazel
        touch oplus/bazel/BUILD
        
        cat <<EOF > oplus/bazel/oplus_modules_define.bzl
        def define_oplus_ddk_module(**kwargs): pass
        def define_oplus_module(**kwargs): pass
        def oplus_module(**kwargs): pass
        def oplus_ddk_module(**kwargs): pass
        EOF

        mkdir -p vendor/oplus
        ln -snf ../../oplus/bazel vendor/oplus/bazel || true

    - name: ğŸ—ï¸ 7. å¯åŠ¨ç¼–è¯‘
      run: |
        cd workspace/kernel_platform
        echo ">>> å‡†å¤‡ç¼–è¯‘..."
        export LTO=thin
        
        # ä½¿ç”¨ python è„šæœ¬ (å®˜æ–¹æ¨èæ–¹å¼)
        python3 build_with_bazel.py -t sm8650 gki --log info || \
        # å¤‡é€‰æ–¹æ¡ˆ
        ./tools/bazel build //msm-kernel:sm8650_gki --jobs=$(nproc)

    - name: ğŸ“¤ 8. ä¸Šä¼ æˆå“
      uses: actions/upload-artifact@v4
      with:
        name: OnePlus_Pad_Pro_Manifest_Kernel
        path: |
          workspace/kernel_platform/out/**/dist/Image
          workspace/kernel_platform/out/**/dist/*.ko
          workspace/kernel_platform/out/**/dist/dtb.img