name: Build OnePlus Pad Pro (Pure + Optimizations)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
    - name: ğŸ’¾ 1. å‡†å¤‡ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 8192
        swap-size-mb: 4096
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-codeql: 'true'

    - name: ğŸ› ï¸ 2. å®‰è£…åŸºç¡€å·¥å…·
      run: |
        sudo apt update
        sudo apt install -y git curl wget build-essential bc bison flex libssl-dev python3 python3-pip android-sdk-libsparse-utils lz4 zstd rsync
        
        # å®‰è£… Repo
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH
        git config --global user.name "Builder"
        git config --global user.email "bot@localhost"

    - name: ğŸ“¥ 3. æ‹‰å–æºç  (ä½¿ç”¨ç¤¾åŒº Manifest)
      run: |
        mkdir -p workspace
        cd workspace
        
        # ä½¿ç”¨ç¤¾åŒºç»´æŠ¤çš„ Manifestï¼Œå®ƒæŒ‡å‘äº†ä¸€åŠ å®˜æ–¹çš„æºç 
        repo init -u https://github.com/Xiaomichael/kernel_manifest.git -b refs/heads/oneplus/sm8650 -m oneplus_pad_pro_v.xml --depth=1
        repo sync -c -j$(nproc) --force-sync --no-tags --no-clone-bundle

    - name: âš¡ 4. åº”ç”¨ä¼˜åŒ–è¡¥ä¸ (åªåšä½ è¦æ±‚çš„)
      run: |
        cd workspace/kernel_platform/msm-kernel
        
        echo ">>> æ­£åœ¨åº”ç”¨æ€§èƒ½ä¸ç½‘ç»œä¼˜åŒ–..."
        
        # å®šä¹‰ä¸€ä¸ªç®€å•çš„æ‰“è¡¥ä¸å‡½æ•°
        add_config() {
            find arch/arm64/configs -name "*defconfig*" | xargs sed -i "$1"
        }

        # 1. å†…å­˜ä¼˜åŒ– (MGLRU + ZSTD)
        add_config '$a CONFIG_LRU_GEN=y\nCONFIG_LRU_GEN_ENABLED=y'
        add_config 's/CONFIG_ZRAM_DEF_COMP_LZ4=y/# CONFIG_ZRAM_DEF_COMP_LZ4 is not set/g'
        add_config '$a CONFIG_ZRAM_DEF_COMP_ZSTD=y'
        
        # 2. æ€§èƒ½ä¼˜åŒ– (å»é™¤ Debug)
        add_config 's/CONFIG_SLUB_DEBUG=y/# CONFIG_SLUB_DEBUG is not set/g'
        add_config 's/CONFIG_DEBUG_INFO=y/# CONFIG_DEBUG_INFO is not set/g'

        # 3. ç½‘ç»œä¸åŠŸè€— (BBR + RCU Lazy)
        add_config '$a CONFIG_RCU_LAZY=y'
        add_config '$a CONFIG_TCP_CONG_BBR=y\nCONFIG_DEFAULT_TCP_CONG="bbr"'
        add_config '$a CONFIG_NET_SCH_CAKE=y\nCONFIG_NET_SCH_FQ_CODEL=y'

        # 4. å»é™¤éªŒè¯ (ä¿ç•™åŸå§‹ç‰ˆæœ¬å·ï¼Œå»æ‰ dirtyï¼Œå»æ‰ç­¾åå¼ºåˆ¶)
        sed -i 's/ -dirty//g' scripts/setlocalversion
        sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' scripts/setlocalversion
        touch .scmversion && echo "" > .scmversion
        
        add_config 's/CONFIG_MODULE_SIG_FORCE=y/# CONFIG_MODULE_SIG_FORCE is not set/g'
        add_config 's/CONFIG_DM_VERITY=y/# CONFIG_DM_VERITY is not set/g'
        add_config 's/CONFIG_DM_VERITY_AVB=y/# CONFIG_DM_VERITY_AVB is not set/g'

    - name: ğŸ”§ 5. è¿˜åŸç¼ºå¤±çš„å®˜æ–¹æ¥å£æ–‡ä»¶ (ä¸åšé­”æ”¹ï¼Œåªåšè¡¥å…¨)
      run: |
        cd workspace/kernel_platform
        
        echo ">>> æ­£åœ¨è¿˜åŸå®˜æ–¹é—­æºçš„ Bazel æ¥å£æ–‡ä»¶..."
        
        # åˆ›å»ºç›®å½•
        mkdir -p build
        mkdir -p oplus/bazel
        touch build/BUILD
        touch oplus/bazel/BUILD
        
        # ã€å…¨é‡è¡¥å…¨ã€‘è¿™é‡ŒåŒ…å«äº†é«˜é€š/ä¸€åŠ æ„å»ºç³»ç»Ÿéœ€è¦çš„æ‰€æœ‰æ¥å£
        # æˆ‘ä»¬ä¸ä¿®æ”¹æºç å»ç»•è¿‡å®ƒä»¬ï¼Œè€Œæ˜¯ç›´æ¥æä¾›è¿™äº›æ¥å£çš„ç©ºå®ç°
        # è¿™æ · Bazel å°±èƒ½æ­£å¸¸å·¥ä½œï¼Œè€Œä¸éœ€è¦å»æ”¹åŠ¨ msm-kernel çš„ä»»ä½•é€»è¾‘
        
        cat <<EOF > build/msm_kernel_extensions.bzl
        # åŸºç¡€å ä½
        def _empty(**kwargs): pass

        # 1. é•œåƒä¸è™šæ‹Ÿæœºå®šä¹‰ (VM/Hypervisor)
        def define_combined_vm_image(**kwargs): pass
        def define_msm_image(**kwargs): pass
        def define_extras(**kwargs): pass
        def define_le_image(**kwargs): pass
        def define_target_variant_modules(**kwargs): pass
        def define_consolidate_gki_modules(**kwargs): pass
        def define_abl_target(**kwargs): pass
        def define_nand_image(**kwargs): pass
        def define_sd_image(**kwargs): pass

        # 2. é…ç½®è·å–
        def get_build_config_fragments(**kwargs): return []
        def get_ksp_list(**kwargs): return []
        def get_ext_modules_list(**kwargs): return []
        def define_techpack_module(**kwargs): pass

        # 3. è®¾å¤‡æ ‘ (DTB/DTBO/DTS)
        def get_dtb_list(**kwargs): return []
        def define_android_dtb(**kwargs): pass
        def pkg_dtb(**kwargs): pass
        def get_dtbo_list(**kwargs): return []
        def define_android_dtbo(**kwargs): pass
        def pkg_dtbo(**kwargs): pass
        def get_dtstree(**kwargs): return None
        def get_dts_list(**kwargs): return []
        
        # 4. Ramdisk ä¸ Vendor
        def get_vendor_ramdisk_binaries(**kwargs): return []
        EOF

        # Oplus ç§æœ‰æ¥å£è¡¥å…¨
        cat <<EOF > oplus/bazel/oplus_modules_define.bzl
        def define_oplus_ddk_module(**kwargs): pass
        def define_oplus_module(**kwargs): pass
        def oplus_module(**kwargs): pass
        def oplus_ddk_module(**kwargs): pass
        def get_oplus_features_as_list(**kwargs): return []
        EOF

        # å»ºç«‹æ ‡å‡†é“¾æ¥ï¼Œç¡®ä¿æºç èƒ½æ‰¾åˆ°è¿™äº›æ–‡ä»¶
        mkdir -p vendor/oplus
        ln -snf ../../oplus/bazel vendor/oplus/bazel || true

    - name: ğŸ—ï¸ 6. å¯åŠ¨ç¼–è¯‘
      run: |
        cd workspace/kernel_platform
        
        echo ">>> å‡†å¤‡ç¼–è¯‘..."
        export LTO=thin
        
        # ä½¿ç”¨ Bazel ç›´æ¥ç¼–è¯‘
        # è¿™æ˜¯æœ€æ ‡å‡†çš„æ–¹æ³•ï¼Œä¸ä¾èµ–ä»»ä½•ç¬¬ä¸‰æ–¹ python è„šæœ¬çš„é­”æ”¹
        ./tools/bazel build //msm-kernel:sm8650_gki --jobs=$(nproc)

    - name: ğŸ“¤ 7. ä¸Šä¼ æˆå“
      uses: actions/upload-artifact@v4
      with:
        name: OnePlus_Pad_Pro_Pure_Kernel
        path: |
          workspace/kernel_platform/out/**/dist/Image
          workspace/kernel_platform/out/**/dist/*.ko
          workspace/kernel_platform/out/**/dist/dtb.img