name: Build OnePlus Pad Pro (Final Fix)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
    - name: ğŸ’¾ 1. æœ€å¤§åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 1024
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-codeql: 'true'

    - name: ğŸ› ï¸ 2. å®‰è£…ç¯å¢ƒä¸ Repo
      run: |
        sudo apt update
        sudo apt install -y git curl wget build-essential bc bison flex libssl-dev python3 python3-pip android-sdk-libsparse-utils lz4 zstd rsync
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH
        git config --global user.name "Action Builder"
        git config --global user.email "action@localhost"

    - name: ğŸ“¥ 3. åˆå§‹åŒ– Google AOSP æ„å»ºåº•åº§
      run: |
        mkdir -p workspace
        cd workspace
        echo ">>> åˆå§‹åŒ– GKI æ„å»ºç¯å¢ƒ..."
        repo init -u https://android.googlesource.com/kernel/manifest -b common-android14-6.1 --depth=1
        repo sync -c -j$(nproc) --no-tags

    - name: ğŸ“¥ 4. æ¤å…¥ OnePlus å†…æ ¸æºç 
      run: |
        cd workspace
        echo ">>> å…‹éš† OnePlus SM8650 æºç ..."
        git clone --depth 1 https://github.com/OnePlusOSS/android_kernel_oneplus_sm8650.git -b oneplus/sm8650_v_15.0.0_pad_pro msm-kernel
        
        # ç¦ç”¨ CheckPatch (é˜²æ­¢è„šæœ¬æ£€æŸ¥ä»£ç é£æ ¼æŠ¥é”™)
        sed -i 's/CheckPatch/echo "Skipping CheckPatch"/' common/scripts/checkpatch.pl || true

    - name: âš¡ 5. æ³¨å…¥ä¼˜åŒ–è¡¥ä¸ (ä¿æŒä¸å˜)
      run: |
        cd workspace/msm-kernel
        
        # å®šä¹‰è¡¥ä¸å‡½æ•°
        apply_patch() {
            find arch/arm64/configs -name "*defconfig*" | xargs sed -i "$1" || echo "Warning: Patch failed for $1"
        }

        # --- A. å†…å­˜ä¸æ€§èƒ½ ---
        apply_patch '$a CONFIG_LRU_GEN=y\nCONFIG_LRU_GEN_ENABLED=y'
        apply_patch 's/CONFIG_ZRAM_DEF_COMP_LZ4=y/# CONFIG_ZRAM_DEF_COMP_LZ4 is not set/g'
        apply_patch '$a CONFIG_ZRAM_DEF_COMP_ZSTD=y'
        apply_patch 's/CONFIG_SLUB_DEBUG=y/# CONFIG_SLUB_DEBUG is not set/g'
        apply_patch 's/CONFIG_DEBUG_INFO=y/# CONFIG_DEBUG_INFO is not set/g'

        # --- B. ç½‘ç»œä¸åŠŸè€— ---
        apply_patch '$a CONFIG_RCU_LAZY=y'
        apply_patch '$a CONFIG_TCP_CONG_BBR=y\nCONFIG_DEFAULT_TCP_CONG="bbr"'
        apply_patch '$a CONFIG_NET_SCH_CAKE=y\nCONFIG_NET_SCH_FQ_CODEL=y'
        
        # --- C. å¼ºåˆ¶å»éªŒè¯ ---
        touch .scmversion && echo "" > .scmversion
        apply_patch 's/CONFIG_MODULE_SIG_FORCE=y/# CONFIG_MODULE_SIG_FORCE is not set/g'
        apply_patch 's/CONFIG_DM_VERITY=y/# CONFIG_DM_VERITY is not set/g'
        apply_patch 's/CONFIG_DM_VERITY_AVB=y/# CONFIG_DM_VERITY_AVB is not set/g'

    - name: ğŸ”§ 6. ä¿®å¤ Bazel ç¯å¢ƒ (å…³é”®æ­¥éª¤!)
      run: |
        cd workspace
        echo ">>> æ­£åœ¨ä¿®å¤ Bazel ç¼ºå¤±çš„åŒ…å®šä¹‰..."

        # 1. åˆ›å»º build ç›®å½• (å¦‚æœä¸å­˜åœ¨)
        mkdir -p build

        # 2. ã€æ ¸å¿ƒä¿®å¤ã€‘åˆ›å»ºç©ºçš„ BUILD æ–‡ä»¶ï¼Œæ»¡è¶³ Bazel çš„è¦æ±‚
        # æŠ¥é”™ explicitly è¯´ï¼šPlease create a BUILD file... Note that this file does not need to do anything except exist.
        touch build/BUILD

        # 3. ä¼ªé€  msm_kernel_extensions.bzl
        # å¦‚æœä¸€åŠ ä»£ç å¼•ç”¨çš„è¿™ä¸ªæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç©ºçš„ä¼ªæ–‡ä»¶ï¼Œé˜²æ­¢ä¸‹ä¸€æ­¥æŠ¥é”™
        if [ ! -f "build/msm_kernel_extensions.bzl" ]; then
            echo "Creating dummy msm_kernel_extensions.bzl..."
            cat <<EOF > build/msm_kernel_extensions.bzl
        # è¿™æ˜¯ä¸€ä¸ªä¼ªé€ çš„ç©ºæ‰©å±•æ–‡ä»¶ï¼Œç”¨äºéª—è¿‡ Bazel æ£€æŸ¥
        def _empty_function(name=None, **kwargs):
            pass
        
        # å¦‚æœä»£ç é‡Œè°ƒç”¨äº†ç‰¹å®šå‡½æ•°ï¼Œè¿™é‡Œå¯èƒ½éœ€è¦è¡¥å……ï¼Œä½†é€šå¸¸ GKI åªéœ€è¦æ–‡ä»¶å­˜åœ¨å³å¯
        EOF
        fi

        # 4. ç¡®ä¿ Bazel èƒ½æ‰¾åˆ° msm-kernel
        # å»ºç«‹è½¯é“¾æ¥ï¼ŒæŠŠ msm-kernel æ”¾åˆ° common/msm-kernel (AOSP æ ‡å‡†ä½ç½®)
        ln -snf ../msm-kernel common/msm-kernel

    - name: ğŸ—ï¸ 7. å¯åŠ¨ç¼–è¯‘
      run: |
        cd workspace
        
        echo ">>> å‡†å¤‡ç¼–è¯‘..."
        export LTO=thin
        
        # ä½¿ç”¨ Bazel ç›´æ¥ç¼–è¯‘
        # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¸å†ä¾èµ– build_with_bazel.pyï¼Œè€Œæ˜¯ç›´æ¥æ“ä½œ
        # //msm-kernel:sm8650_gki æ˜¯ä»£ç é‡Œå®šä¹‰çš„ç›®æ ‡
        tools/bazel build //msm-kernel:sm8650_gki --jobs=$(nproc)

    - name: ğŸ“¤ 8. ä¸Šä¼ æˆå“
      uses: actions/upload-artifact@v4
      with:
        name: OnePlus_Pad_Pro_Fixed_Kernel
        path: |
          workspace/out/**/dist/Image
          workspace/out/**/dist/*.ko
          workspace/out/**/dist/dtb.img
