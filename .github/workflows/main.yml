name: Build OnePlus Pad Pro (Final Fix V5)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
    - name: ğŸ’¾ 1. æœ€å¤§åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 8192
        swap-size-mb: 4096
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-codeql: 'true'

    - name: ğŸ› ï¸ 2. å®‰è£…æ„å»ºç¯å¢ƒ
      run: |
        sudo apt update
        sudo apt install -y git curl wget build-essential bc bison flex libssl-dev python3 python3-pip android-sdk-libsparse-utils lz4 zstd rsync
        
        # å®‰è£… Repo
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH
        
        # é…ç½® Git
        git config --global user.name "Builder"
        git config --global user.email "bot@localhost"
        git config --global color.ui false

    - name: ğŸ“¥ 3. åŒæ­¥æºç  (Community Manifest)
      run: |
        mkdir -p workspace
        cd workspace
        
        echo ">>> åˆå§‹åŒ– Repo..."
        repo init -u https://github.com/Xiaomichael/kernel_manifest.git -b refs/heads/oneplus/sm8650 -m oneplus_pad_pro_v.xml --depth=1
        
        echo ">>> å¼€å§‹åŒæ­¥æºç ..."
        repo sync -c -j$(nproc) --force-sync --no-tags --no-clone-bundle

    - name: âš¡ 4. æ³¨å…¥ä¼˜åŒ–è¡¥ä¸
      run: |
        cd workspace/kernel_platform/msm-kernel
        
        echo ">>> å¼€å§‹æ³¨å…¥ä¼˜åŒ–è¡¥ä¸..."
        
        apply_patch() {
            find arch/arm64/configs -name "*defconfig*" | xargs sed -i "$1" || echo "Warn: $1"
        }

        # --- A. å†…å­˜ä¸æ€§èƒ½ ---
        apply_patch '$a CONFIG_LRU_GEN=y\nCONFIG_LRU_GEN_ENABLED=y'
        apply_patch 's/CONFIG_ZRAM_DEF_COMP_LZ4=y/# CONFIG_ZRAM_DEF_COMP_LZ4 is not set/g'
        apply_patch '$a CONFIG_ZRAM_DEF_COMP_ZSTD=y'
        apply_patch 's/CONFIG_SLUB_DEBUG=y/# CONFIG_SLUB_DEBUG is not set/g'
        apply_patch 's/CONFIG_DEBUG_INFO=y/# CONFIG_DEBUG_INFO is not set/g'

        # --- B. ç½‘ç»œä¸åŠŸè€— ---
        apply_patch '$a CONFIG_RCU_LAZY=y'
        apply_patch '$a CONFIG_TCP_CONG_BBR=y\nCONFIG_DEFAULT_TCP_CONG="bbr"'
        apply_patch '$a CONFIG_NET_SCH_CAKE=y\nCONFIG_NET_SCH_FQ_CODEL=y'

        # --- C. ç»•è¿‡éªŒè¯ ---
        sed -i 's/ -dirty//g' scripts/setlocalversion
        sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' scripts/setlocalversion
        touch .scmversion && echo "" > .scmversion
        
        apply_patch 's/CONFIG_MODULE_SIG_FORCE=y/# CONFIG_MODULE_SIG_FORCE is not set/g'
        apply_patch 's/CONFIG_DM_VERITY=y/# CONFIG_DM_VERITY is not set/g'
        apply_patch 's/CONFIG_DM_VERITY_AVB=y/# CONFIG_DM_VERITY_AVB is not set/g'

    - name: ğŸ”§ 5. ä¿®å¤ Bazel ä¾èµ– (è¡¥å…¨ define_extras)
      run: |
        cd workspace/kernel_platform
        
        echo ">>> æ­£åœ¨ä¿®å¤ Bazel ç¯å¢ƒ..."

        # -------------------------------------------------------
        # [ä¿®å¤ A] ä¼ªé€  //build:msm_kernel_extensions.bzl
        # -------------------------------------------------------
        echo "Mocking build extensions..."
        mkdir -p build
        touch build/BUILD
        
        # ã€å…³é”®ä¿®æ”¹ã€‘è¡¥å…¨äº† define_extras ä»¥åŠå…¶ä»–å¯èƒ½ç”¨åˆ°çš„å‡½æ•°
        cat <<EOF > build/msm_kernel_extensions.bzl
        def _empty(**kwargs):
            pass
            
        def define_combined_vm_image(**kwargs):
            pass
            
        def define_msm_image(**kwargs):
            pass
            
        def define_extras(**kwargs):
            pass

        def define_target_variant_modules(**kwargs):
            pass
        EOF

        # -------------------------------------------------------
        # [ä¿®å¤ B] ä¼ªé€  //oplus/bazel
        # -------------------------------------------------------
        echo "Mocking Oplus private modules..."
        mkdir -p oplus/bazel
        touch oplus/bazel/BUILD
        
        cat <<EOF > oplus/bazel/oplus_modules_define.bzl
        def define_oplus_ddk_module(**kwargs):
            pass
        def define_oplus_module(**kwargs):
            pass
        def oplus_module(**kwargs):
            pass
        def oplus_ddk_module(**kwargs):
            pass
        def get_oplus_features_as_list(**kwargs):
            return []
        EOF

        # å»ºç«‹ vendor é“¾æ¥
        mkdir -p vendor/oplus
        ln -snf ../../oplus/bazel vendor/oplus/bazel || true

    - name: ğŸ—ï¸ 6. å¯åŠ¨ç¼–è¯‘
      run: |
        cd workspace/kernel_platform
        
        echo ">>> å‡†å¤‡ç¼–è¯‘..."
        export LTO=thin
        
        # ç›´æ¥ä½¿ç”¨ Bazel ç›´æ¥ç¼–è¯‘
        echo ">>> å¯åŠ¨æ„å»º (Target: sm8650 gki)..."
        ./tools/bazel build //msm-kernel:sm8650_gki --jobs=$(nproc)

    - name: ğŸ“¤ 7. ä¸Šä¼ æˆå“
      uses: actions/upload-artifact@v4
      with:
        name: OnePlus_Pad_Pro_Fixed_Kernel
        path: |
          workspace/kernel_platform/out/**/dist/Image
          workspace/kernel_platform/out/**/dist/*.ko
          workspace/kernel_platform/out/**/dist/dtb.img